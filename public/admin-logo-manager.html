<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logo Manager - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .station-row {
            transition: all 0.2s ease;
        }
        .station-row:hover {
            background-color: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .search-input {
            transition: all 0.3s ease;
        }
        .search-input:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .logo-img {
            transition: all 0.3s ease;
        }
        .logo-img:hover {
            transform: scale(1.05);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #10b981;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .no-logo {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: 2px dashed #d1d5db;
        }
        .logo-source-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .source-local { background-color: #10b981; }
        .source-external { background-color: #3b82f6; }
        .source-none { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/admin/stations" class="text-gray-600 hover:text-gray-900 mr-4">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h1 class="text-xl font-bold text-gray-900">Logo Manager</h1>
                    <span class="ml-2 px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded-full">Admin</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        <span id="stations-count">0</span> stations found
                    </span>
                    <button onclick="bulkToggleInactive()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-eye-slash mr-2"></i>Bulk Disable Missing Logos
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Search and Filters -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <!-- Search Bar -->
            <div class="mb-6">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" 
                           id="search-input" 
                           class="search-input block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Search stations by name, country, genre...">
                </div>
            </div>

            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="filter-status" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Stations</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Logo Status</label>
                    <select id="filter-logo" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Logos</option>
                        <option value="has-local">Has Local Image</option>
                        <option value="has-external">Has External Logo</option>
                        <option value="missing">Missing Logo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                    <select id="filter-country" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Genre</label>
                    <select id="filter-genre" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Genres</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="clearFilters()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-times mr-2"></i>Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Logo Statistics</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="stat-local">-</div>
                    <div class="text-sm text-gray-600">Local Images</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="stat-external">-</div>
                    <div class="text-sm text-gray-600">External Logos</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="stat-missing">-</div>
                    <div class="text-sm text-gray-600">Missing Logos</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="stat-active">-</div>
                    <div class="text-sm text-gray-600">Active Stations</div>
                </div>
            </div>
        </div>

        <!-- Stations List -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Station Logo Management</h3>
                <p class="text-sm text-gray-600 mt-1">Manage station logos and active status. Local images take priority over external logos.</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full table-fixed">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-1/2 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Station</th>
                            <th class="w-1/4 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Logo</th>
                            <th class="w-20 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="w-32 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stations-table" class="bg-white divide-y divide-gray-200">
                        <!-- Stations will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between mt-6">
            <div class="text-sm text-gray-700">
                Showing <span id="pagination-start">0</span> to <span id="pagination-end">0</span> of <span id="pagination-total">0</span> stations
            </div>
            <div class="flex items-center space-x-2">
                <button id="prev-page-btn" onclick="goToPage(currentPage - 1)" 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <i class="fas fa-chevron-left mr-1"></i>Previous
                </button>
                
                <div class="flex items-center space-x-1" id="pagination-numbers">
                    <!-- Page numbers will be inserted here -->
                </div>
                
                <button id="next-page-btn" onclick="goToPage(currentPage + 1)" 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    Next<i class="fas fa-chevron-right ml-1"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Station Website Modal -->
    <div id="website-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 w-full">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Station Website</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Station Name</label>
                <input type="text" id="website-station-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50" readonly>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Website URL</label>
                <div class="flex items-center space-x-2">
                    <input type="url" id="website-url" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 bg-gray-50" readonly>
                    <button onclick="copyWebsiteUrl()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg" title="Copy URL">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Stream URL</label>
                <div class="flex items-center space-x-2">
                    <input type="url" id="website-stream-url" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 bg-gray-50" readonly>
                    <button onclick="copyStreamUrl()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg" title="Copy Stream URL">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeWebsiteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Close</button>
                <button onclick="openWebsiteInNewTab()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-external-link-alt mr-2"></i>Visit Website
                </button>
            </div>
        </div>
    </div>

    <!-- Logo Edit Modal -->
    <div id="logo-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 w-full">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Edit Logo URL</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Station Name</label>
                <input type="text" id="edit-station-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50" readonly>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Logo URL</label>
                <input type="url" id="edit-logo-url" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                       placeholder="https://example.com/logo.png">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                <div class="flex items-center space-x-4">
                    <img id="edit-logo-preview" src="" class="w-16 h-16 rounded-lg object-cover border border-gray-300" style="display: none;">
                    <div id="edit-logo-placeholder" class="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center border border-gray-300">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeLogoEditModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="saveLogo()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Save Logo</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                <span class="text-gray-700">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let stationsPerPage = 50;
        let currentEditingStationId = null;
        let currentWebsiteStationId = null;
        let allStations = [];
        let filteredStations = [];

        // Load stations on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStations();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Search
            document.getElementById('search-input').addEventListener('input', debounce(filterStations, 300));
            
            // Filters
            document.getElementById('filter-status').addEventListener('change', filterStations);
            document.getElementById('filter-logo').addEventListener('change', filterStations);
            document.getElementById('filter-country').addEventListener('change', filterStations);
            document.getElementById('filter-genre').addEventListener('change', filterStations);
            
            // Logo URL preview
            document.getElementById('edit-logo-url').addEventListener('input', debounce(updateLogoPreview, 500));
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function loadStations() {
            showLoading();
            try {
                console.log('Loading stations...');
                
                // Try different API endpoints in order of preference
                const endpoints = [
                    '/stations?includeInactive=true',  // Match core-data.js format
                    '/stations?limit=1000&includeInactive=true',  // Original format
                    '/stations'  // Fallback to basic endpoint
                ];
                
                let allStationsData = null;
                let lastError = null;
                
                for (const endpoint of endpoints) {
                    try {
                        console.log(`Trying endpoint: ${endpoint}`);
                        const response = await fetch(endpoint);
                        console.log(`Response status for ${endpoint}:`, response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Response data type:`, typeof data, 'Length/Keys:', Array.isArray(data) ? data.length : Object.keys(data));
                            
                            // Handle different response formats
                            if (Array.isArray(data)) {
                                allStationsData = data;
                                break;
                            } else if (data && data.stations && Array.isArray(data.stations)) {
                                allStationsData = data.stations;
                                break;
                            } else if (data && typeof data === 'object') {
                                console.log('Unexpected data format:', data);
                                lastError = `Unexpected data format from ${endpoint}`;
                            }
                        } else {
                            const errorText = await response.text();
                            lastError = `${endpoint}: ${response.status} ${response.statusText} - ${errorText}`;
                            console.error('API Error:', lastError);
                        }
                    } catch (fetchError) {
                        lastError = `${endpoint}: ${fetchError.message}`;
                        console.error('Fetch Error:', lastError);
                    }
                }
                
                if (allStationsData && allStationsData.length > 0) {
                    allStations = allStationsData;
                    console.log('Successfully loaded stations:', allStations.length);
                    console.log('Sample station:', allStations[0]);
                    populateFilters();
                    updateStats();
                    filterStations();
                } else {
                    const errorMsg = lastError || 'No stations data received from any endpoint';
                    console.error('Failed to load stations:', errorMsg);
                    alert(`Failed to load stations: ${errorMsg}`);
                    
                    // Show empty state
                    allStations = [];
                    updateStats();
                    filterStations();
                }
            } catch (error) {
                console.error('Error loading stations:', error);
                alert(`Error loading stations: ${error.message}`);
                
                // Show empty state
                allStations = [];
                updateStats();
                filterStations();
            } finally {
                hideLoading();
            }
        }

        function populateFilters() {
            // Populate country filter
            const countries = [...new Set(allStations.map(s => s.country).filter(Boolean))].sort();
            const countrySelect = document.getElementById('filter-country');
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            // Populate genre filter
            const genres = [...new Set(allStations.map(s => s.genre).filter(Boolean))].sort();
            const genreSelect = document.getElementById('filter-genre');
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre.charAt(0).toUpperCase() + genre.slice(1);
                genreSelect.appendChild(option);
            });
        }

        function updateStats() {
            const localCount = allStations.filter(s => s.local_image_url).length;
            const externalCount = allStations.filter(s => !s.local_image_url && s.logo).length;
            const missingCount = allStations.filter(s => !s.local_image_url && !s.logo).length;
            const activeCount = allStations.filter(s => s.isActive).length;

            document.getElementById('stat-local').textContent = localCount;
            document.getElementById('stat-external').textContent = externalCount;
            document.getElementById('stat-missing').textContent = missingCount;
            document.getElementById('stat-active').textContent = activeCount;
        }

        function filterStations() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const logoFilter = document.getElementById('filter-logo').value;
            const countryFilter = document.getElementById('filter-country').value;
            const genreFilter = document.getElementById('filter-genre').value;

            filteredStations = allStations.filter(station => {
                // Search filter
                if (searchTerm && !station.name.toLowerCase().includes(searchTerm) &&
                    !station.country?.toLowerCase().includes(searchTerm) &&
                    !station.genre?.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Status filter
                if (statusFilter === 'active' && !station.isActive) return false;
                if (statusFilter === 'inactive' && station.isActive) return false;

                // Logo filter
                if (logoFilter === 'has-local' && !station.local_image_url) return false;
                if (logoFilter === 'has-external' && (station.local_image_url || !station.logo)) return false;
                if (logoFilter === 'missing' && (station.local_image_url || station.logo)) return false;

                // Country filter
                if (countryFilter && station.country !== countryFilter) return false;

                // Genre filter
                if (genreFilter && station.genre !== genreFilter) return false;

                return true;
            });

            // Reset to page 1 when filtering
            currentPage = 1;
            renderStations();
        }

        function renderStations() {
            const tbody = document.getElementById('stations-table');
            tbody.innerHTML = '';

            document.getElementById('stations-count').textContent = filteredStations.length;

            // Calculate pagination
            totalPages = Math.ceil(filteredStations.length / stationsPerPage);
            const startIndex = (currentPage - 1) * stationsPerPage;
            const endIndex = Math.min(startIndex + stationsPerPage, filteredStations.length);
            const stationsToShow = filteredStations.slice(startIndex, endIndex);

            console.log(`Rendering page ${currentPage} of ${totalPages} (${stationsToShow.length} stations)`);
            
            stationsToShow.forEach((station, index) => {
                const row = createStationRow(station);
                tbody.appendChild(row);
            });
            
            updatePaginationUI();
            console.log('Finished rendering stations. Total rows:', tbody.children.length);
        }

        function updatePaginationUI() {
            // Update pagination info
            const startIndex = (currentPage - 1) * stationsPerPage + 1;
            const endIndex = Math.min(currentPage * stationsPerPage, filteredStations.length);
            
            document.getElementById('pagination-start').textContent = filteredStations.length > 0 ? startIndex : 0;
            document.getElementById('pagination-end').textContent = endIndex;
            document.getElementById('pagination-total').textContent = filteredStations.length;

            // Update buttons
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;

            // Update page numbers
            updatePageNumbers();
        }

        function updatePageNumbers() {
            const container = document.getElementById('pagination-numbers');
            container.innerHTML = '';

            // Show page numbers (max 5 visible)
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            // Adjust start if we're near the end
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-2 text-sm font-medium rounded-md ${
                    i === currentPage 
                        ? 'bg-blue-600 text-white' 
                        : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-50'
                }`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                container.appendChild(pageBtn);
            }
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderStations();
        }

        function createStationRow(station) {
            const row = document.createElement('tr');
            row.className = 'station-row';

            // Determine logo source and URL
            let logoUrl = null;
            let logoSource = 'none';
            if (station.local_image_url) {
                logoUrl = station.local_image_url;
                logoSource = 'local';
            } else if (station.logo) {
                logoUrl = station.logo;
                logoSource = 'external';
            }

            // Create station info cell
            const stationCell = document.createElement('td');
            stationCell.className = 'px-6 py-4';
            stationCell.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-20 w-20">
                        <div class="w-20 h-20 rounded-lg overflow-hidden border border-gray-300 relative">
                            ${logoUrl ? 
                                `<img src="${logoUrl}" alt="${station.name}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full bg-gray-100 flex items-center justify-center">
                                    <i class="fas fa-image text-gray-400 text-xl"></i>
                                </div>`
                            }
                            <div class="logo-source-indicator source-${logoSource}"></div>
                        </div>
                    </div>
                    <div class="ml-4 min-w-0 flex-1 overflow-hidden">
                        <div class="text-sm font-medium text-gray-900 truncate">
                            <button onclick="showStationWebsite(${station.id})" class="text-left hover:text-blue-600 underline cursor-pointer truncate block max-w-full" title="${station.name}">
                                ${station.name}
                            </button>
                        </div>
                        <div class="text-sm text-gray-500 truncate">${station.country || 'Unknown'} • ${station.genre || 'Unknown'}</div>
                    </div>
                </div>
            `;

            // Create logo status cell
            const logoStatusCell = document.createElement('td');
            logoStatusCell.className = 'px-6 py-4 whitespace-nowrap';
            let statusBadge = '';
            if (station.local_image_url) {
                statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <i class="fas fa-cloud mr-1"></i>Local Image
                </span>`;
            } else if (station.logo) {
                statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <i class="fas fa-link mr-1"></i>External Logo
                </span>`;
            } else {
                statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    <i class="fas fa-exclamation-triangle mr-1"></i>Missing Logo
                </span>`;
            }
            logoStatusCell.innerHTML = `
                <div class="text-sm text-gray-900">${statusBadge}</div>
                ${logoUrl ? `<div class="text-xs text-gray-500 mt-1 truncate">${logoUrl}</div>` : ''}
            `;

            // Create toggle cell
            const toggleCell = document.createElement('td');
            toggleCell.className = 'px-6 py-4 whitespace-nowrap';
            const toggleLabel = document.createElement('label');
            toggleLabel.className = 'toggle-switch';
            const toggleInput = document.createElement('input');
            toggleInput.type = 'checkbox';
            toggleInput.checked = station.isActive || false;
            toggleInput.onchange = function() {
                toggleStationStatus(station.id, this.checked);
            };
            const toggleSlider = document.createElement('span');
            toggleSlider.className = 'slider';
            toggleLabel.appendChild(toggleInput);
            toggleLabel.appendChild(toggleSlider);
            toggleCell.appendChild(toggleLabel);

            // Create actions cell
            const actionsCell = document.createElement('td');
            actionsCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium';
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'flex items-center space-x-3';

            // Edit button
            const editBtn = document.createElement('button');
            editBtn.className = 'text-blue-600 hover:text-blue-900 p-2 hover:bg-blue-50 rounded-lg transition-colors';
            editBtn.title = 'Edit logo URL';
            editBtn.innerHTML = '<i class="fas fa-edit text-lg"></i>';
            editBtn.onclick = function() { editLogo(station.id); };
            actionsContainer.appendChild(editBtn);

            // Download buttons
            if (station.local_image_url) {
                const downloadNewBtn = document.createElement('button');
                downloadNewBtn.className = 'text-green-600 hover:text-green-900 p-2 hover:bg-green-50 rounded-lg transition-colors';
                downloadNewBtn.title = 'Download new logo';
                downloadNewBtn.innerHTML = '<i class="fas fa-download text-lg"></i>';
                downloadNewBtn.onclick = function() { downloadNewLogo(station.id); };
                actionsContainer.appendChild(downloadNewBtn);
            } else if (station.logo) {
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'text-purple-600 hover:text-purple-900 p-2 hover:bg-purple-50 rounded-lg transition-colors';
                downloadBtn.title = 'Download to local storage';
                downloadBtn.innerHTML = '<i class="fas fa-cloud-download-alt text-lg"></i>';
                downloadBtn.onclick = function() { downloadLogo(station.id); };
                actionsContainer.appendChild(downloadBtn);
            }

            // Edit image button (only for local images)
            if (station.local_image_url) {
                const editImageBtn = document.createElement('button');
                editImageBtn.className = 'text-orange-600 hover:text-orange-900 p-2 hover:bg-orange-50 rounded-lg transition-colors';
                editImageBtn.title = 'Edit image';
                editImageBtn.innerHTML = '<i class="fas fa-paint-brush text-lg"></i>';
                editImageBtn.onclick = function() { editStationImage(station.id, station.name); };
                actionsContainer.appendChild(editImageBtn);
            }

            // Preview button
            if (logoUrl) {
                const previewBtn = document.createElement('button');
                previewBtn.className = 'text-gray-600 hover:text-gray-900 p-2 hover:bg-gray-50 rounded-lg transition-colors';
                previewBtn.title = 'Preview logo';
                previewBtn.innerHTML = '<i class="fas fa-eye text-lg"></i>';
                previewBtn.onclick = function() { previewLogo(logoUrl, station.name); };
                actionsContainer.appendChild(previewBtn);
            }

            actionsCell.appendChild(actionsContainer);

            // Append all cells to row
            row.appendChild(stationCell);
            row.appendChild(logoStatusCell);
            row.appendChild(toggleCell);
            row.appendChild(actionsCell);

            return row;
        }

        async function toggleStationStatus(stationId, isActive) {
            try {
                const response = await fetch(`/stations/${stationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ isActive })
                });

                if (response.ok) {
                    // Update local data
                    const station = allStations.find(s => s.id === stationId);
                    if (station) {
                        station.isActive = isActive;
                        updateStats();
                        filterStations();
                    }
                } else {
                    console.error('Failed to update station status');
                    // Revert the toggle
                    const checkbox = event.target;
                    checkbox.checked = !isActive;
                }
            } catch (error) {
                console.error('Error updating station status:', error);
            }
        }

        function editLogo(stationId) {
            const station = allStations.find(s => s.id === stationId);
            if (!station) return;

            currentEditingStationId = stationId;
            document.getElementById('edit-station-name').value = station.name;
            document.getElementById('edit-logo-url').value = station.logo || '';
            updateLogoPreview();
            document.getElementById('logo-edit-modal').classList.remove('hidden');
        }

        function closeLogoEditModal() {
            document.getElementById('logo-edit-modal').classList.add('hidden');
            currentEditingStationId = null;
        }

        function updateLogoPreview() {
            const url = document.getElementById('edit-logo-url').value;
            const preview = document.getElementById('edit-logo-preview');
            const placeholder = document.getElementById('edit-logo-placeholder');

            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
            }
        }

        async function saveLogo() {
            if (!currentEditingStationId) return;

            const logoUrl = document.getElementById('edit-logo-url').value;
            
            try {
                const response = await fetch(`/stations/${currentEditingStationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ logo: logoUrl })
                });

                if (response.ok) {
                    // Update local data
                    const station = allStations.find(s => s.id === currentEditingStationId);
                    if (station) {
                        station.logo = logoUrl;
                        updateStats();
                        filterStations();
                    }
                    closeLogoEditModal();
                } else {
                    console.error('Failed to update logo');
                    alert('Failed to update logo. Please try again.');
                }
            } catch (error) {
                console.error('Error updating logo:', error);
                alert('Error updating logo. Please try again.');
            }
        }

        async function downloadLogo(stationId) {
            const station = allStations.find(s => s.id === stationId);
            if (!station) {
                alert('Station not found');
                return;
            }

            const logoUrl = station.logo;
            if (!logoUrl) {
                alert('This station has no logo URL to download');
                return;
            }

            if (!confirm(`Download logo from ${logoUrl} to local storage?`)) return;

            showLoading();
            try {
                console.log(`Downloading logo for station ${stationId}:`, logoUrl);
                const response = await fetch(`/images/download/${stationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: logoUrl })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Download result:', result);
                    // Update station data with new local image URL
                    if (station) {
                        station.local_image_url = result.url;
                        updateStats();
                        renderStations(); // Re-render to show edit button
                    }
                    alert('Logo downloaded successfully!');
                } else {
                    const errorText = await response.text();
                    console.error('Download failed:', response.status, errorText);
                    alert(`Failed to download logo: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Error downloading logo:', error);
                alert(`Error downloading logo: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function downloadNewLogo(stationId) {
            const station = allStations.find(s => s.id === stationId);
            if (!station) {
                alert('Station not found');
                return;
            }

            const logoUrl = station.logo;
            if (!logoUrl) {
                alert('This station has no logo URL to download');
                return;
            }

            if (!confirm(`Download new logo from ${logoUrl}? This will replace the current local image.`)) return;

            showLoading();
            try {
                console.log(`Downloading new logo for station ${stationId}:`, logoUrl);
                const response = await fetch(`/images/download/${stationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: logoUrl })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Download result:', result);
                    // Update station data with new local image URL
                    if (station) {
                        station.local_image_url = result.url;
                        updateStats();
                        renderStations(); // Re-render to show edit button
                    }
                    alert('New logo downloaded successfully!');
                } else {
                    const errorText = await response.text();
                    console.error('Download failed:', response.status, errorText);
                    alert(`Failed to download new logo: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Error downloading new logo:', error);
                alert(`Error downloading new logo: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function previewLogo(url, name) {
            window.open(url, '_blank', 'width=800,height=600');
        }

        function editStationImage(stationId, stationName) {
            const station = allStations.find(s => s.id === stationId);
            if (!station) {
                alert('Station not found');
                return;
            }

            if (!station.local_image_url) {
                // Show warning dialog
                const shouldDownload = confirm(
                    `⚠️  No saved image found for "${stationName}"\n\n` +
                    `To edit an image, you need to download and save it locally first.\n\n` +
                    `Would you like to download the logo now?`
                );
                
                if (shouldDownload) {
                    if (station.logo) {
                        downloadLogo(stationId);
                    } else {
                        alert('This station has no logo URL to download. Please add a logo URL first using the edit button.');
                    }
                }
                return;
            }

            // Set up message listener for when the editor saves
            const messageListener = (event) => {
                // Only listen to messages from our image editor
                if (event.data && event.data.type === 'imageUpdated' && event.data.stationId === stationId) {
                    console.log('Image editor saved new image:', event.data);
                    
                    // Remove this listener
                    window.removeEventListener('message', messageListener);
                    
                    // Refresh the station data by reloading from server
                    refreshStationData(stationId);
                }
            };
            
            window.addEventListener('message', messageListener);
            
            // Open the image editor with station parameters
            const editorUrl = `/admin/simple-image-editor?stationId=${stationId}&stationName=${encodeURIComponent(stationName)}`;
            const editorWindow = window.open(
                editorUrl, 
                '_blank', 
                'width=1000,height=700,scrollbars=yes,resizable=yes'
            );
            
            // Clean up listener if window is closed without saving
            const checkClosed = setInterval(() => {
                if (editorWindow && editorWindow.closed) {
                    clearInterval(checkClosed);
                    window.removeEventListener('message', messageListener);
                }
            }, 1000);
        }


        async function refreshStationData(stationId) {
            try {
                console.log(`Refreshing data for station ${stationId}`);
                const response = await fetch(`/stations/${stationId}`);
                if (response.ok) {
                    const updatedStation = await response.json();
                    console.log('Updated station data:', updatedStation);
                    
                    // Update the station in our local array
                    const stationIndex = allStations.findIndex(s => s.id === stationId);
                    if (stationIndex !== -1) {
                        // Force cache bust for the image URL if it has a timestamp
                        if (updatedStation.local_image_url) {
                            const url = new URL(updatedStation.local_image_url);
                            url.searchParams.set('t', Date.now());
                            updatedStation.local_image_url = url.toString();
                        }
                        
                        allStations[stationIndex] = updatedStation;
                        
                        // Update filtered stations if this station is in the current view
                        const filteredIndex = filteredStations.findIndex(s => s.id === stationId);
                        if (filteredIndex !== -1) {
                            filteredStations[filteredIndex] = updatedStation;
                        }
                        
                        // Re-render the stations to show updated image
                        updateStats();
                        renderStations();
                        
                        console.log('Station data refreshed successfully with cache busting');
                    }
                } else {
                    console.error('Failed to refresh station data:', response.status);
                }
            } catch (error) {
                console.error('Error refreshing station data:', error);
            }
        }

        async function bulkToggleInactive() {
            const stationsWithoutLogos = allStations.filter(s => !s.local_image_url && !s.logo && s.isActive);
            
            if (stationsWithoutLogos.length === 0) {
                alert('No active stations without logos found.');
                return;
            }

            if (!confirm(`This will disable ${stationsWithoutLogos.length} stations that have no logos. Continue?`)) {
                return;
            }

            showLoading();
            let updated = 0;
            
            for (const station of stationsWithoutLogos) {
                try {
                    const response = await fetch(`/stations/${station.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ isActive: false })
                    });

                    if (response.ok) {
                        station.isActive = false;
                        updated++;
                    }
                } catch (error) {
                    console.error('Error updating station:', error);
                }
            }

            hideLoading();
            alert(`${updated} stations have been disabled.`);
            updateStats();
            filterStations();
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-logo').value = '';
            document.getElementById('filter-country').value = '';
            document.getElementById('filter-genre').value = '';
            filterStations();
        }

        function showStationWebsite(stationId) {
            const station = allStations.find(s => s.id === stationId);
            if (!station) return;

            currentWebsiteStationId = stationId;
            document.getElementById('website-station-name').value = station.name || '';
            document.getElementById('website-url').value = station.homepage || station.website || '';
            document.getElementById('website-stream-url').value = station.streamUrl || station.stream_url || '';
            document.getElementById('website-modal').classList.remove('hidden');
        }

        function closeWebsiteModal() {
            document.getElementById('website-modal').classList.add('hidden');
            currentWebsiteStationId = null;
        }

        function openWebsiteInNewTab() {
            const websiteUrl = document.getElementById('website-url').value;
            if (websiteUrl) {
                // Ensure URL has protocol
                let url = websiteUrl;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank', 'noopener,noreferrer');
            } else {
                alert('No website URL available for this station.');
            }
        }

        async function copyWebsiteUrl() {
            const websiteUrl = document.getElementById('website-url').value;
            if (websiteUrl) {
                try {
                    await navigator.clipboard.writeText(websiteUrl);
                    // Show brief success feedback
                    const button = event.target.closest('button');
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    button.classList.add('bg-green-600');
                    button.classList.remove('bg-gray-600');
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.classList.remove('bg-green-600');
                        button.classList.add('bg-gray-600');
                    }, 1000);
                } catch (err) {
                    console.error('Failed to copy URL:', err);
                    alert('Failed to copy URL to clipboard');
                }
            }
        }

        async function copyStreamUrl() {
            const streamUrl = document.getElementById('website-stream-url').value;
            if (streamUrl) {
                try {
                    await navigator.clipboard.writeText(streamUrl);
                    // Show brief success feedback
                    const button = event.target.closest('button');
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    button.classList.add('bg-green-600');
                    button.classList.remove('bg-gray-600');
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.classList.remove('bg-green-600');
                        button.classList.add('bg-gray-600');
                    }, 1000);
                } catch (err) {
                    console.error('Failed to copy stream URL:', err);
                    alert('Failed to copy stream URL to clipboard');
                }
            }
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Close modals when clicking outside
        document.getElementById('logo-edit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLogoEditModal();
            }
        });

        document.getElementById('website-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWebsiteModal();
            }
        });
    </script>
</body>
</html>